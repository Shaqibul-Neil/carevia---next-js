# NextAuth v4 + Passkey (SimpleWebAuthn) ржЗржоржкрзНрж▓рж┐ржорзЗржирзНржЯрзЗрж╢ржи ржЧрж╛ржЗржб

ржпрзЗрж╣рзЗрждрзБ ржЖржкржирж┐ ржЖржкржирж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯрзЗ **NextAuth v4** ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрзЗржи ржПржмржВ ржПржЯрж┐ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржЪрж╛ржЪрзНржЫрзЗржи ржирж╛, рждрж╛ржЗ ржЖржорж╛ржжрзЗрж░ **SimpleWebAuthn** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржПржХржЯрж┐ ржХрж╛рж╕рзНржЯржо ржкрж╛рж╕ржХрж┐ рж╕рж┐рж╕рзНржЯрзЗржо рждрзИрж░рж┐ ржХрж░рждрзЗ рж╣ржмрзЗред

## ржПржЗ ржкржжрзНржзрждрж┐рж░ рж╕рзБржмрж┐ржзрж╛
- ржмрж┐ржжрзНржпржорж╛ржи рж▓ржЧржЗржи рж╕рж┐рж╕рзНржЯрзЗржо (Email/Password) ржирж╖рзНржЯ рж╣ржмрзЗ ржирж╛ред
- Auth.js (v5) ржП ржорж╛ржЗржЧрзНрж░рзЗржЯ ржХрж░рж╛рж░ ржЭрж╛ржорзЗрж▓рж╛ ржирзЗржЗред
- ржкрж╛рж╕ржХрж┐ ржПржХржЯрж┐ "Add-on" ржлрж┐ржЪрж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗред

---

## рзз. ржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржкрзНржпрж╛ржХрзЗржЬ
```bash
npm install @simplewebauthn/server @simplewebauthn/browser
```

## рзи. ржбрзЗржЯрж╛ржмрзЗрж╕ ржкрж░рж┐ржмрж░рзНрждржи
ржЗржЙржЬрж╛рж░рзЗрж░ ржЬржирзНржп ржПржХржЯрж┐ ржирждрзБржи ржлрж┐рж▓рзНржб ржмрж╛ ржХрж╛рж▓рзЗржХрж╢ржи рж▓рж╛ржЧржмрзЗ (ржпрзЗржоржи: `authenticators`) ржпрзЗржЦрж╛ржирзЗ ржЗржЙржЬрж╛рж░рзЗрж░ ржкрж╛ржмрж▓рж┐ржХ ржХрж┐ ржПржмржВ ржбрж┐ржнрж╛ржЗрж╕рзЗрж░ рждржерзНржп рж╕рзЗржн ржерж╛ржХржмрзЗред
- `credentialID`: ржЗржЙржирж┐ржХ ржЖржЗржбрж┐ред
- `publicKey`: ржмрж╛рзЯрзЛржорзЗржЯрзНрж░рж┐ржХ ржХрзАред
- `counter`: рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ ржЪрзЗржХред

## рзй. ржЗржоржкрзНрж▓рж┐ржорзЗржирзНржЯрзЗрж╢ржи ржлрзНрж▓рзЛ (Passkey Login)

### ржзрж╛ржк рзз: ржЪрзНржпрж╛рж▓рзЗржЮрзНржЬ ржЬрзЗржирж╛рж░рзЗржЯ ржХрж░рж╛ (Server)
ржПржХржЯрж┐ ржПржкрж┐ржЖржЗ рж░рзБржЯ рждрзИрж░рж┐ ржХрж░рждрзЗ рж╣ржмрзЗ ржпрж╛ ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗрж░ ржЬржирзНржп ржПржХржЯрж┐ рж╕рж┐ржХрж┐ржЙрж░ ржЪрзНржпрж╛рж▓рзЗржЮрзНржЬ ржкрж╛ржарж╛ржмрзЗред
```javascript
// app/api/passkey/login-options/route.js
import { generateAuthenticationOptions } from '@simplewebauthn/server';
// ... ржЪрзНржпрж╛рж▓рзЗржЮрзНржЬ ржЬрзЗржирж╛рж░рзЗржЯ ржХрж░рзЗ ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗ ржкрж╛ржарж╛ржи
```

### ржзрж╛ржк рзи: ржмрж╛рзЯрзЛржорзЗржЯрзНрж░рж┐ржХ ржкржкржЖржк (Client)
рж▓ржЧржЗржи ржкрзЗржЬрзЗ "Login with Passkey" ржмрж╛ржЯржирзЗ ржХрзНрж▓рж┐ржХ ржХрж░рж▓рзЗ ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржЗржЙржЬрж╛рж░рзЗрж░ ржлрж┐ржЩрзНржЧрж╛рж░ржкрзНрж░рж┐ржирзНржЯ ржЪрж╛ржЗржмрзЗред
```javascript
// LoginForm.jsx
import { startAuthentication } from '@simplewebauthn/browser';

const asseResp = await startAuthentication(optionsFromServer);
// ржПржЗ рж░рзЗрж╕ржкржирзНрж╕ржЯрж┐ ржЖржмрж╛рж░ рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржкрж╛ржарж╛ржи ржнрзЗрж░рж┐ржлрж╛ржЗ ржХрж░рждрзЗ
```

### ржзрж╛ржк рзй: ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи ржПржмржВ NextAuth рж╕рзЗрж╢ржи (Final)
рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗрж░ рж░рзЗрж╕ржкржирзНрж╕ ржнрзЗрж░рж┐ржлрж╛ржЗ рж╣рзЯрзЗ ржЧрзЗрж▓рзЗ ржЖржкржирж┐ NextAuth-ржПрж░ рж╕рж░рж╛рж╕рж░рж┐ `signIn` ржорзЗржержб ржХрж▓ ржХрж░ржмрзЗржиред
```javascript
// ржнрзЗрж░рж┐ржлрж╛ржЗ рж╕ржлрж▓ рж╣рж▓рзЗ ржлрзНрж░ржирзНржЯржПржирзНржбрзЗ ржПржЯрж┐ ржХрж▓ ржХрж░рзБржи:
signIn('credentials', {
  email: userEmail,
  isPasskey: true, // ржПржЯрж┐ ржПржХржЯрж┐ ржлрзНрж▓рзНржпрж╛ржЧ рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗ
  redirect: true,
  callbackUrl: '/dashboard'
});
```

---

## рзк. `authOptions.js` ржП ржкрж░рж┐ржмрж░рзНрждржи
ржЖржкржирж╛рж░ ржмрж░рзНрждржорж╛ржи `authorize` ржлрж╛ржВрж╢ржирзЗ рж╕рж╛ржорж╛ржирзНржп ржкрж░рж┐ржмрж░рзНрждржи ржЖржирждрзЗ рж╣ржмрзЗ ржпрж╛рждрзЗ ржПржЯрж┐ ржкрж╛рж╕ржХрж┐ рж▓ржЧржЗржи ржмрзБржЭрждрзЗ ржкрж╛рж░рзЗред

```javascript
async authorize(credentials) {
  if (credentials.isPasskey) {
    // ржПржЦрж╛ржирзЗ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржЪрзЗржХ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ
    // рж╢рзБржзрзБ ржЗржорзЗржЗрж▓ ржжрж┐рзЯрзЗ ржЗржЙржЬрж╛рж░ржХрзЗ ржбрзЗржЯрж╛ржмрзЗрж╕ ржерзЗржХрзЗ ржЦрзБржБржЬрзЗ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗ ржжрж┐ржи
    const user = await findUserByEmail(credentials.email);
    return user;
  }
  
  // ржЖржкржирж╛рж░ ржмрж┐ржжрзНржпржорж╛ржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб рж▓ржЧржЗржи рж▓ржЬрж┐ржХ ржПржЦрж╛ржирзЗ ржерж╛ржХржмрзЗ...
}
```

---

## рзл. ржЗржЙржЬрж╛рж░ ржПржирж░рзЛрж▓ржорзЗржирзНржЯ (Register Passkey)
ржЗржЙржЬрж╛рж░ рж▓ржЧржЗржи ржерж╛ржХрж╛рж░ рж╕ржорзЯ рждрж╛ржХрзЗ рждрж╛рж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржерзЗржХрзЗ "ржкрж╛рж╕ржХрж┐ рж╕рзЗржЯржЖржк" ржХрж░рж╛рж░ ржЕржкрж╢ржи ржжрж┐рждрзЗ рж╣ржмрзЗред 
- ржПржХржЗржнрж╛ржмрзЗ `generateRegistrationOptions` (рж╕рж╛рж░рзНржнрж╛рж░) -> `startRegistration` (ржмрзНрж░рж╛ржЙржЬрж╛рж░) -> ржнрзЗрж░ржлрж┐ржХрзЗрж╢ржи ржПржмржВ ржбрзЗржЯрж╛ржмрзЗрж╕рзЗ рж╕рзЗржнред

## рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк
рзз. **SimpleWebAuthn** ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗрж░ ржмрж╛рзЯрзЛржорзЗржЯрзНрж░рж┐ржХ ржХрж╛ржЬржЧрзБрж▓рзЛ ржХрж░ржмрзЗред
рзи. ржмрж╛рзЯрзЛржорзЗржЯрзНрж░рж┐ржХ ржорзНржпрж╛ржЪ ржХрж░рж▓рзЗ ржЖржкржирж┐ NextAuth-ржХрзЗ ржмрж▓ржмрзЗржи ржпрзЗ ржЗржЙржЬрж╛рж░ ржнрзЗрж░рж┐ржлрж╛ржЗржбред
рзй. NextAuth ржЗржЙржЬрж╛рж░ржХрзЗ ржПржХржЯрж┐ JWT ржЯрзЛржХрзЗржи ржмрж╛ рж╕рзЗрж╢ржи ржжрж┐рзЯрзЗ ржжрж┐ржмрзЗред

---

## ЁЯТб ржмрж┐рж╢рзЗрж╖ ржирзЛржЯ: Face Recognition ржХрж┐ ржЖрж▓рж╛ржжрж╛ржнрж╛ржмрзЗ ржпрзЛржЧ ржХрж░рждрзЗ рж╣ржмрзЗ?
ржирж╛, ржЖрж▓рж╛ржжрж╛ ржХрзЛржб рж▓рж╛ржЧржмрзЗ ржирж╛ред Passkey (WebAuthn) ржкрзНрж░ржпрзБржХрзНрждрж┐рждрзЗ **Face ID, Fingerprint, ржПржмржВ Windows Hello** рж╕рзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗред ржЗржЙржЬрж╛рж░рзЗрж░ ржбрж┐ржнрж╛ржЗрж╕рзЗ ржпрж╛ рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ (ржпрзЗржоржи iPhone-ржП Face ID ржмрж╛ рж▓рзНржпрж╛ржкржЯржкрзЗ Camera Login), ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржирж┐ржЬрзЗ ржерзЗржХрзЗржЗ рж╕рзЗржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗред ржбрзЗржнрзЗрж▓ржкрж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ ржЖржкржирж╛ржХрзЗ рж╢рзБржзрзБ ржкрж╛рж╕ржХрж┐ рж╕рж┐рж╕рзНржЯрзЗржоржЯрж┐ ржЗржоржкрзНрж▓рж┐ржорзЗржирзНржЯ ржХрж░рж▓рзЗржЗ рж╣ржмрзЗред

---
*Created for Carevia Project (NextAuth v4 Compatible)*
